{% if not producers and referent %}
    {% set producers = delivery.get_producers_for_referent(referent) %}
{% elif not producers %}
    {% set producers = delivery.producers %}
{% endif %}
{% for producer in producers %}
    {% set producer_obj = delivery.producers[producer] %}
    <h2>{{ producer_obj.name }}
        {% if producer_obj.needs_price_update(delivery) %}*{% endif %}
        {% if edit_mode or request.user.is_staff or producer_obj.referent == request.user.email %}
            <span class="edit">
            <a class="button" href="/distribution/{{ delivery.id }}/{{ producer_obj.id }}/Ã©diter"><i class="icon-ribbon"></i>&nbsp; GÃ©rer ceâ‹…tte producteurâ‹…rice</a>
        </span>
        {% endif %}
    </h2>
    <h5>{% if producer_obj.description %}{{ producer_obj.description }}{% endif %}. RÃ©fÃ©rentâ‹…e : <a href="mailto:{{ producer_obj.referent }}">{{ producer_obj.referent_name }}</a> / {{ producer_obj.referent_tel }}</h5>
{% if not delivery.get_products_by(producer) %}
ðŸ˜” Ceâ‹…tte producteurâ‹…rice n'a pas encore de produits. Voulez vous <a href="/distribution/{{ delivery.id }}/{{ producer }}/ajouter-produit">en rajouter un ?</a>
{% else %}
<table class="delivery pure-table">
    <thead>
        <tr>
            <th class="product">Produit</th>
            <th class="price">Prix</th>
            {% if delivery.has_packing %}
                <th class="packing">Conditionnement</th>
            {% endif %}
            <th class="amount">Total</th>
            {% if not list_only %}
            {% for orderer, order in delivery.orders.items() %}
                {% set orderer_name = request.groups.groups[orderer].name %}
                <th class="person">
                    {% if request.user and (request.user.is_staff or request.user.is_referent(delivery)) %}
                        <a href="/distribution/{{ delivery.id }}/commander?orderer={{ orderer }}" title="{{ orderer }}">{{ orderer_name }}</a>
                    {% else %}
                        <span title="{{ orderer }}">{{ orderer_name }}</span>
                    {% endif %}
                </th>
            {% endfor %}
            {% endif %}
        </tr>
    </thead>
    <tbody>
        {% for product in delivery.get_products_by(producer) %}
        <tr>
            <th class="product {% if product.rupture %}rupture{% endif %}">{% if edit_mode %}<a href="/distribution/{{ delivery.id }}/{{ product.producer }}/produit/{{ product.ref }}/Ã©diter">{% endif %}{% if edit_mode %}<i class="icon-pencil"></i>&nbsp;{% endif %}{{ product }}{% if edit_mode %}</a>{% endif %}{% if product.rupture %} {{ product.rupture }}{% endif %}
            <td>{{ product.price | round(2) }} â‚¬</td>
            {% if delivery.has_packing %}
                <td class="packing">{% if product.packing %}{{ product.packing }} x {% endif %} {{ product.unit }}</td>
            {% endif %}
            <th{% if delivery.status == delivery.ADJUSTMENT and delivery.product_missing(product) %} class="missing" title="Les commandes individuelles ne correspondent pas aux conditionnements"{% endif %}>
                {{ delivery.product_wanted(product) }}
                {% if delivery.status == delivery.ADJUSTMENT and delivery.product_missing(product) %} (âˆ’{{ delivery.product_missing(product) }})
                {% if request.user.is_staff %}<a href="/distribution/{{ delivery.id }}/ajuster/{{ product.ref }}" class="button" title="ajuster le produit">ajuster</a>{% endif %}
                {% endif %}
            </th>
            {% if not list_only %}
            {% for email, order in delivery.orders.items() %}
                <td title="CommandÃ©: {{ order[product.ref].wanted }} â€” AjustÃ©: {{ "%+d"|format(order[product.ref].adjustment) }}">{{ order[product.ref].quantity or "â€”" }}</td>
            {% endfor %}
            {% endif %}
        </tr>
        {% endfor %}
        <tr>
            <th class="total"><i class="icon-pricetags"></i> Total</th><td>â€”</td>
            {% if delivery.has_packing %}
                <td>â€”</td>
            {% endif %}
          
            <th class="total">{{ delivery.total_for_producer(producer) }} â‚¬</th>
            {% if not list_only %}
                {% for email, order in delivery.orders.items() %}
                <td>{{ order.total(delivery.get_products_by(producer)) }} â‚¬</td>
                {% endfor %}
            {% endif %}
        </tr>
    </tbody>
</table>
{% endif %}
<br />
{% endfor %}